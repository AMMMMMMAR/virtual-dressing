{% extends 'base.html' %}
{% load static %}

{% block title %}Virtual Body Scan - Virtual Fitting System{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">Virtual Body Scan</h1>
        <p class="text-xl text-gray-600">Follow the instructions to capture your body measurements</p>
    </div>

    <!-- Progress Steps -->
    <div class="mb-12">
        <div class="flex items-center justify-center space-x-4">
            <div id="step1" class="flex items-center">
                <div class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">
                    1</div>
                <span class="ml-2 font-medium text-gray-900">Front View</span>
            </div>
            <div class="w-16 h-1 bg-gray-300"></div>
            <div id="step2" class="flex items-center opacity-50">
                <div
                    class="w-10 h-10 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold">
                    2</div>
                <span class="ml-2 font-medium text-gray-600">Side View (Optional)</span>
            </div>
            <div class="w-16 h-1 bg-gray-300"></div>
            <div id="step3" class="flex items-center opacity-50">
                <div
                    class="w-10 h-10 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold">
                    3</div>
                <span class="ml-2 font-medium text-gray-600">Processing</span>
            </div>
        </div>
    </div>

    <!-- Camera Interface -->
    <div class="bg-white rounded-2xl shadow-xl p-8">
        <div id="camera-container" class="mb-6 relative">
            <div class="relative bg-gray-900 rounded-xl overflow-hidden" style="aspect-ratio: 4/3;">
                <video id="video" autoplay playsinline
                    class="w-full h-full object-cover transform scale-x-[-1]"></video> <!-- Mirrored -->
                <canvas id="canvas" class="hidden"></canvas>
                <canvas id="overlay-canvas" class="absolute inset-0 pointer-events-none w-full h-full"></canvas>

                <!-- Visual Guide Overlay -->
                <div id="visual-guide"
                    class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-70">
                    <!-- Head Guide -->
                    <div class="w-32 h-40 border-4 border-dashed border-white/70 rounded-full mb-2"></div>
                    <!-- Body Guide -->
                    <div class="w-80 h-96 border-4 border-dashed border-white/70 rounded-3xl rounded-t-lg"></div>
                </div>

                <!-- Real-time Status Panel -->
                <div id="status-panel" class="absolute top-4 left-0 right-0 flex justify-center pointer-events-none">
                    <div id="status-badge"
                        class="bg-black/60 backdrop-blur-md text-white px-6 py-2 rounded-full flex items-center gap-2 transition-all duration-300">
                        <div id="status-indicator" class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></div>
                        <span id="status-text" class="font-medium">Initializing camera...</span>
                    </div>
                </div>

                <!-- Loading spinner -->
                <div id="loading" class="hidden absolute inset-0 bg-black/70 flex items-center justify-center z-50">
                    <div class="text-center">
                        <div
                            class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mx-auto mb-4">
                        </div>
                        <p class="text-white text-lg">Processing your scan...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div id="instructions" class="bg-indigo-50 rounded-xl p-6 mb-6">
            <h3 class="font-bold text-lg text-indigo-900 mb-3">ðŸ“¸ Instructions:</h3>
            <ul class="space-y-2 text-indigo-800">
                <li>âœ“ Stand 2-3 meters away from the camera</li>
                <li>âœ“ Ensure your full body is visible in the frame</li>
                <li>âœ“ Stand straight with arms slightly away from your body</li>
                <li>âœ“ Make sure the lighting is good and even</li>
            </ul>
        </div>

        <!-- Preview Images -->
        <div id="preview-container" class="hidden mb-6">
            <h3 class="font-bold text-lg text-gray-900 mb-3">Captured Images:</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-600 mb-2">Front View</p>
                    <img id="front-preview" class="w-full rounded-lg border-2 border-gray-300" alt="Front view">
                </div>
                <div id="side-preview-container" class="hidden">
                    <p class="text-sm text-gray-600 mb-2">Side View</p>
                    <img id="side-preview" class="w-full rounded-lg border-2 border-gray-300" alt="Side view">
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden bg-red-50 border-2 border-red-200 rounded-xl p-4 mb-6">
            <p class="text-red-800 font-medium"></p>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-4 justify-center">
            <button id="capture-front"
                class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-8 py-4 rounded-lg font-bold text-lg hover:shadow-lg transition transform hover:scale-105">
                ðŸ“¸ Capture Front View
            </button>
            <button id="capture-side"
                class="hidden bg-gradient-to-r from-pink-600 to-rose-600 text-white px-8 py-4 rounded-lg font-bold text-lg hover:shadow-lg transition transform hover:scale-105">
                ðŸ“¸ Capture Side View
            </button>
            <button id="skip-side"
                class="hidden bg-gray-500 text-white px-8 py-4 rounded-lg font-bold text-lg hover:shadow-lg transition">
                Skip Side View
            </button>
            <button id="process-scan"
                class="hidden bg-gradient-to-r from-emerald-600 to-teal-600 text-white px-8 py-4 rounded-lg font-bold text-lg hover:shadow-lg transition transform hover:scale-105">
                âœ¨ Process Scan
            </button>
            <button id="retake"
                class="hidden bg-gray-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-gray-600 transition">
                ðŸ”„ Retake
            </button>
        </div>
    </div>
</div>

<script src="{% static 'js/camera.js' %}"></script>
{% endblock %}

{% block extra_js %}
<script>
    // Camera and scanning logic
    let video, canvas, context, overlayCanvas, overlayContext;
    let frontImageData = null;
    let sideImageData = null;
    let currentStep = 1;
    let analysisInterval = null;
    let isAnalyzing = false;

    document.addEventListener('DOMContentLoaded', function () {
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        context = canvas.getContext('2d');
        overlayCanvas = document.getElementById('overlay-canvas');
        overlayContext = overlayCanvas.getContext('2d');

        // Resize overlay canvas to match video
        window.addEventListener('resize', resizeOverlay);

        // Initialize camera
        initCamera();

        // Button event listeners
        document.getElementById('capture-front').addEventListener('click', captureFront);
        document.getElementById('capture-side').addEventListener('click', captureSide);
        document.getElementById('skip-side').addEventListener('click', skipSide);
        document.getElementById('process-scan').addEventListener('click', processScan);
        document.getElementById('retake').addEventListener('click', retake);
    });

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 960 },
                    facingMode: 'user'
                }
            });
            video.srcObject = stream;

            video.onloadedmetadata = () => {
                resizeOverlay();
                // Start real-time analysis
                startRealTimeAnalysis();
            };
        } catch (error) {
            showError('Camera access denied. Please allow camera access to use this feature.');
            console.error('Camera error:', error);
            updateStatus('error', 'Camera access denied');
        }
    }

    function resizeOverlay() {
        overlayCanvas.width = video.videoWidth || video.clientWidth;
        overlayCanvas.height = video.videoHeight || video.clientHeight;
    }

    function startRealTimeAnalysis() {
        if (isAnalyzing) return;
        isAnalyzing = true;

        updateStatus('warning', 'Align your body with the guide');

        // Analysis loop
        analysisInterval = setInterval(async () => {
            if (!isAnalyzing || video.paused || video.ended) return;

            // Capture low-res frame
            const analysisCanvas = document.createElement('canvas');
            analysisCanvas.width = 320;
            analysisCanvas.height = 240;
            const ctx = analysisCanvas.getContext('2d');

            // Draw video to canvas (handle mirroring if needed, but for analysis mirror doesn't matter much unless we draw landmarks back)
            // We mirrored video with CSS, so we should mirror drawing if we want natural feedback? 
            // Standard webcam is usually mirrored for user.
            ctx.drawImage(video, 0, 0, 320, 240);

            const imageData = analysisCanvas.toDataURL('image/jpeg', 0.6);

            try {
                const response = await fetch('{% url "fitting_system:analyze_frame" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                const result = await response.json();
                handleAnalysisResult(result);

            } catch (error) {
                console.error("Analysis frame error:", error);
            }
        }, 500); // 2 FPS to reduce load
    }

    function stopAnalysis() {
        isAnalyzing = false;
        if (analysisInterval) {
            clearInterval(analysisInterval);
            analysisInterval = null;
        }
        overlayContext.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
    }

    function handleAnalysisResult(result) {
        if (!result.detected) {
            updateStatus('error', 'No person detected');
            clearLandmarks();
            return;
        }

        updateStatus(result.status, result.message);

        // Draw landmarks if available
        if (result.landmarks && result.landmarks.length > 0) {
            drawLandmarks(result.landmarks);
        }
    }

    function updateStatus(status, message) {
        const badge = document.getElementById('status-badge');
        const indicator = document.getElementById('status-indicator');
        const text = document.getElementById('status-text');
        const guide = document.getElementById('visual-guide');

        text.textContent = message;

        // Reset classes
        indicator.className = 'w-3 h-3 rounded-full animate-pulse transition-colors duration-300';
        badge.className = 'backdrop-blur-md px-6 py-2 rounded-full flex items-center gap-2 transition-all duration-300 border-2';
        guide.className = 'absolute inset-0 flex flex-col items-center justify-center pointer-events-none transition-opacity duration-300';

        if (status === 'good') {
            indicator.classList.add('bg-green-400');
            badge.classList.add('bg-green-900/60', 'border-green-400');
            guide.classList.add('opacity-30'); // Fade guide when good
        } else if (status === 'warning') {
            indicator.classList.add('bg-yellow-400');
            badge.classList.add('bg-yellow-900/60', 'border-yellow-400');
            guide.classList.add('opacity-70');
        } else {
            indicator.classList.add('bg-red-500');
            badge.classList.add('bg-red-900/60', 'border-red-500');
            guide.classList.add('opacity-90');
        }
    }

    function drawLandmarks(landmarks) {
        overlayContext.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

        overlayContext.fillStyle = '#00FF00';
        overlayContext.strokeStyle = '#00FF00';
        overlayContext.lineWidth = 2;

        // Landmarks are normalized (0-1). Scale to canvas.
        // NOTE: Video is mirrored in CSS (scale-x-[-1]).
        // To match landmarks to mirrored video, we need to flip X.

        landmarks.forEach(lm => {
            const x = (1 - lm.x) * overlayCanvas.width; // Flip X
            const y = lm.y * overlayCanvas.height;

            overlayContext.beginPath();
            overlayContext.arc(x, y, 4, 0, 2 * Math.PI);
            overlayContext.fill();
        });

        // Can add skeleton lines here if desired
    }

    function clearLandmarks() {
        overlayContext.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
    }

    function captureFront() {
        stopAnalysis(); // Stop analyzing when captured

        captureImage('front');
        frontImageData = getImageData();

        // Show preview
        document.getElementById('front-preview').src = frontImageData;
        document.getElementById('preview-container').classList.remove('hidden');

        // Update UI
        document.getElementById('capture-front').classList.add('hidden');
        document.getElementById('capture-side').classList.remove('hidden');
        document.getElementById('skip-side').classList.remove('hidden');
        document.getElementById('visual-guide').classList.add('hidden'); // Hide guide

        // Update step
        updateStep(2);

        // Update instructions
        document.getElementById('instructions').innerHTML = `
            <h3 class="font-bold text-lg text-indigo-900 mb-3">ðŸ“¸ Optional: Side View</h3>
            <ul class="space-y-2 text-indigo-800">
                <li>âœ“ Turn 90 degrees to your right</li>
                <li>âœ“ Stand in the same position</li>
                <li>âœ“ Keep your arms at your sides</li>
                <li>âœ“ Or skip this step to continue</li>
            </ul>
        `;
    }

    function captureSide() {
        captureImage('side');
        sideImageData = getImageData();

        // Show preview
        document.getElementById('side-preview').src = sideImageData;
        document.getElementById('side-preview-container').classList.remove('hidden');

        // Update UI
        document.getElementById('capture-side').classList.add('hidden');
        document.getElementById('skip-side').classList.add('hidden');
        document.getElementById('process-scan').classList.remove('hidden');
        document.getElementById('retake').classList.remove('hidden');

        // Update step
        updateStep(3);
    }

    function skipSide() {
        // Update UI
        document.getElementById('capture-side').classList.add('hidden');
        document.getElementById('skip-side').classList.add('hidden');
        document.getElementById('process-scan').classList.remove('hidden');
        document.getElementById('retake').classList.remove('hidden');

        // Update step
        updateStep(3);
    }

    function captureImage(type) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        // Draw mirrored if video is mirrored? 
        // Video element has transform scale-x-[-1].
        // context.drawImage draws raw video frame (not mirrored).
        // If we want captured image to look like what user sees, we should flip it.

        context.save();
        context.scale(-1, 1);
        context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
        context.restore();
    }

    function getImageData() {
        return canvas.toDataURL('image/jpeg', 0.9);
    }

    async function processScan() {
        if (!frontImageData) {
            showError('Please capture at least a front view image.');
            return;
        }

        // Show loading
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('process-scan').disabled = true;

        try {
            const response = await fetch('{% url "fitting_system:process_scan" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    front_image: frontImageData,
                    side_image: sideImageData
                })
            });

            const data = await response.json();

            if (data.success) {
                // Redirect to recommendations page
                window.location.href = `/recommendations/${data.session_id}/`;
            } else {
                showError(data.error || 'Processing failed. Please try again.');
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('process-scan').disabled = false;
            }
        } catch (error) {
            showError('Network error. Please check your connection and try again.');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('process-scan').disabled = false;
            console.error('Processing error:', error);
        }
    }

    function retake() {
        // Reset everything
        frontImageData = null;
        sideImageData = null;
        currentStep = 1;

        // Reset UI
        document.getElementById('preview-container').classList.add('hidden');
        document.getElementById('capture-front').classList.remove('hidden');
        document.getElementById('capture-side').classList.add('hidden');
        document.getElementById('skip-side').classList.add('hidden');
        document.getElementById('process-scan').classList.add('hidden');
        document.getElementById('retake').classList.add('hidden');
        document.getElementById('error-message').classList.add('hidden');
        document.getElementById('visual-guide').classList.remove('hidden'); // Show guide again

        // Reset instructions
        document.getElementById('instructions').innerHTML = `
            <h3 class="font-bold text-lg text-indigo-900 mb-3">ðŸ“¸ Instructions:</h3>
            <ul class="space-y-2 text-indigo-800">
                <li>âœ“ Stand 2-3 meters away from the camera</li>
                <li>âœ“ Ensure your full body is visible in the frame</li>
                <li>âœ“ Stand straight with arms slightly away from your body</li>
                <li>âœ“ Make sure the lighting is good and even</li>
            </ul>
        `;

        updateStep(1);

        // Restart analysis
        startRealTimeAnalysis();
    }

    function updateStep(step) {
        currentStep = step;

        // Reset all steps
        for (let i = 1; i <= 3; i++) {
            const stepEl = document.getElementById(`step${i}`);
            if (i < step) {
                stepEl.classList.remove('opacity-50');
                stepEl.querySelector('div').classList.remove('bg-gray-300', 'text-gray-600');
                stepEl.querySelector('div').classList.add('bg-green-500', 'text-white');
                stepEl.querySelector('span').classList.remove('text-gray-600');
                stepEl.querySelector('span').classList.add('text-gray-900');
            } else if (i === step) {
                stepEl.classList.remove('opacity-50');
                stepEl.querySelector('div').classList.remove('bg-gray-300', 'text-gray-600');
                stepEl.querySelector('div').classList.add('bg-indigo-600', 'text-white');
                stepEl.querySelector('span').classList.remove('text-gray-600');
                stepEl.querySelector('span').classList.add('text-gray-900');
            } else {
                stepEl.classList.add('opacity-50');
                stepEl.querySelector('div').classList.remove('bg-indigo-600', 'bg-green-500', 'text-white');
                stepEl.querySelector('div').classList.add('bg-gray-300', 'text-gray-600');
                stepEl.querySelector('span').classList.remove('text-gray-900');
                stepEl.querySelector('span').classList.add('text-gray-600');
            }
        }
    }

    function showError(message) {
        const errorEl = document.getElementById('error-message');
        errorEl.querySelector('p').textContent = message;
        errorEl.classList.remove('hidden');
    }
</script>
{% endblock %}