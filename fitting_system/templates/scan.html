{% extends 'base.html' %}
{% load static %}

{% block title %}Virtual Body Scan - Virtual Fitting System{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">Virtual Body Scan</h1>
        <p class="text-xl text-gray-600">Choose how you'd like to provide your body images</p>
    </div>

    <!-- Mode Selector Tabs -->
    <div class="flex justify-center mb-8">
        <div class="inline-flex bg-gray-100 rounded-xl p-1.5 shadow-inner">
            <button id="tab-camera" onclick="switchMode('camera')"
                class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-300 bg-white text-indigo-700 shadow-md">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                    </path>
                </svg>
                Camera Scan
            </button>
            <button id="tab-upload" onclick="switchMode('upload')"
                class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-300 text-gray-500 hover:text-gray-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                    </path>
                </svg>
                Upload Images
            </button>
        </div>
    </div>

    <!-- ===== CAMERA MODE ===== -->
    <div id="camera-mode">

        <!-- Progress Steps -->
        <div class="mb-12">
            <div class="flex items-center justify-center space-x-2 md:space-x-4 flex-wrap gap-y-4">
                <div id="step1" class="flex items-center">
                    <div
                        class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">
                        1</div>
                    <span class="ml-2 font-medium text-gray-900">Front View</span>
                </div>
                <div class="w-8 md:w-16 h-1 bg-gray-300"></div>
                <div id="step2" class="flex items-center opacity-50">
                    <div
                        class="w-10 h-10 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold">
                        2</div>
                    <span class="ml-2 font-medium text-gray-600">Side View</span>
                </div>
                <div class="w-8 md:w-16 h-1 bg-gray-300"></div>
                <div id="step3" class="flex items-center opacity-50">
                    <div
                        class="w-10 h-10 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold">
                        3</div>
                    <span class="ml-2 font-medium text-gray-600">Skin Tone</span>
                </div>
                <div class="w-8 md:w-16 h-1 bg-gray-300"></div>
                <div id="step4" class="flex items-center opacity-50">
                    <div
                        class="w-10 h-10 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold">
                        4</div>
                    <span class="ml-2 font-medium text-gray-600">Processing</span>
                </div>
            </div>
        </div>

        <!-- Camera Interface -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div id="camera-container" class="mb-6 relative">
                <div class="relative bg-gray-900 rounded-xl overflow-hidden" style="aspect-ratio: 4/3;">
                    <video id="video" autoplay playsinline
                        class="w-full h-full object-cover transform scale-x-[-1]"></video> <!-- Mirrored -->
                    <canvas id="canvas" class="hidden"></canvas>
                    <canvas id="overlay-canvas" class="absolute inset-0 pointer-events-none w-full h-full"></canvas>

                    <!-- Visual Guide Overlay - Full Body -->
                    <div id="visual-guide-body"
                        class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-70 transition-all duration-300">
                        <!-- Head Guide -->
                        <div id="head-guide"
                            class="w-32 h-40 border-4 border-dashed border-white/70 rounded-full mb-2 transition-colors duration-300">
                        </div>
                        <!-- Body Guide -->
                        <div id="body-guide"
                            class="w-80 h-96 border-4 border-dashed border-white/70 rounded-3xl rounded-t-lg transition-colors duration-300">
                        </div>
                    </div>

                    <!-- Visual Guide Overlay - Face/Selfie for Skin Tone -->
                    <div id="visual-guide-face"
                        class="hidden absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-70 transition-all duration-300">
                        <!-- Face Circle Guide -->
                        <div id="face-guide"
                            class="w-64 h-80 border-4 border-dashed border-amber-400/80 rounded-full transition-colors duration-300">
                        </div>
                        <p class="text-amber-400 font-bold mt-4 text-lg bg-black/40 px-4 py-2 rounded-lg">üì± Come close!
                            Fill the circle with your face</p>
                    </div>

                    <!-- Countdown Overlay -->
                    <div id="countdown-overlay"
                        class="hidden absolute inset-0 flex items-center justify-center pointer-events-none z-40">
                        <div class="text-center">
                            <div id="countdown-number"
                                class="text-9xl font-black text-white drop-shadow-2xl animate-pulse">
                            </div>
                            <p class="text-2xl font-bold text-white mt-4 bg-green-600/80 px-6 py-2 rounded-full">Hold
                                still!
                            </p>
                        </div>
                    </div>

                    <!-- Capture Flash Effect -->
                    <div id="capture-flash"
                        class="hidden absolute inset-0 bg-white pointer-events-none z-50 animate-flash">
                    </div>

                    <!-- Real-time Status Panel -->
                    <div id="status-panel"
                        class="absolute top-4 left-0 right-0 flex justify-center pointer-events-none">
                        <div id="status-badge"
                            class="bg-black/60 backdrop-blur-md text-white px-6 py-2 rounded-full flex items-center gap-2 transition-all duration-300">
                            <div id="status-indicator" class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></div>
                            <span id="status-text" class="font-medium">Initializing camera...</span>
                        </div>
                    </div>

                    <!-- Auto-Capture Progress Bar -->
                    <div id="auto-capture-bar" class="hidden absolute bottom-4 left-4 right-4 pointer-events-none">
                        <div class="bg-black/50 rounded-full p-1">
                            <div id="capture-progress"
                                class="h-2 rounded-full bg-gradient-to-r from-green-400 to-emerald-500 transition-all duration-100"
                                style="width: 0%"></div>
                        </div>
                        <p class="text-center text-white text-sm mt-2 font-medium">Auto-capturing when position is
                            correct...</p>
                    </div>

                    <!-- Loading spinner -->
                    <div id="loading" class="hidden absolute inset-0 bg-black/70 flex items-center justify-center z-50">
                        <div class="text-center">
                            <div
                                class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mx-auto mb-4">
                            </div>
                            <p class="text-white text-lg">Processing your scan...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div id="instructions" class="bg-indigo-50 rounded-xl p-6 mb-6">
                <h3 class="font-bold text-lg text-indigo-900 mb-3">üì∏ Step 1: Front View (Auto-Capture)</h3>
                <ul class="space-y-2 text-indigo-800">
                    <li>‚úì Stand 2-3 meters away from the camera</li>
                    <li>‚úì Align your body with the guide outline</li>
                    <li>‚úì Stand straight with arms slightly away from your body</li>
                    <li>‚ö° <strong>Image will capture automatically when you're positioned correctly!</strong></li>
                </ul>
            </div>

            <!-- Preview Images -->
            <div id="preview-container" class="hidden mb-6">
                <h3 class="font-bold text-lg text-gray-900 mb-3">Captured Images:</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div id="front-preview-container" class="hidden">
                        <p class="text-sm text-gray-600 mb-2">Front View ‚úì</p>
                        <img id="front-preview" class="w-full rounded-lg border-2 border-green-400" alt="Front view">
                    </div>
                    <div id="side-preview-container" class="hidden">
                        <p class="text-sm text-gray-600 mb-2">Side View ‚úì</p>
                        <img id="side-preview" class="w-full rounded-lg border-2 border-green-400" alt="Side view">
                    </div>
                    <div id="skin-preview-container" class="hidden">
                        <p class="text-sm text-gray-600 mb-2">Skin Tone ‚úì</p>
                        <img id="skin-preview" class="w-full rounded-lg border-2 border-amber-400" alt="Skin tone">
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden bg-red-50 border-2 border-red-200 rounded-xl p-4 mb-6">
                <p class="text-red-800 font-medium"></p>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4 justify-center flex-wrap">
                <button id="skip-side"
                    class="hidden bg-gray-500 text-white px-8 py-4 rounded-lg font-bold text-lg hover:shadow-lg transition">
                    ‚è≠Ô∏è Skip Side View
                </button>
                <button id="process-scan"
                    class="hidden bg-gradient-to-r from-emerald-600 to-teal-600 text-white px-8 py-4 rounded-lg font-bold text-lg hover:shadow-lg transition transform hover:scale-105">
                    ‚ú® Process Scan
                </button>
                <button id="retake"
                    class="hidden bg-gray-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-gray-600 transition">
                    üîÑ Start Over
                </button>
            </div>
        </div>

    </div><!-- /camera-mode -->

    <!-- ===== UPLOAD MODE ===== -->
    <div id="upload-mode" class="hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Upload Body Images</h2>
                <p class="text-gray-500">Upload clear, full-body photos for AI analysis</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Front Image Upload -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        üì∏ Front View <span class="text-red-500">*</span> <span
                            class="text-gray-400 font-normal">(required)</span>
                    </label>
                    <div id="front-dropzone"
                        class="relative border-2 border-dashed border-indigo-300 rounded-xl p-8 text-center cursor-pointer transition-all duration-300 hover:border-indigo-500 hover:bg-indigo-50/50 group"
                        onclick="document.getElementById('front-file-input').click()"
                        ondragover="handleDragOver(event, 'front-dropzone')"
                        ondragleave="handleDragLeave(event, 'front-dropzone')" ondrop="handleDrop(event, 'front')">
                        <input type="file" id="front-file-input" accept="image/*" class="hidden"
                            onchange="handleFileSelect(event, 'front')">
                        <div id="front-upload-placeholder">
                            <div
                                class="w-16 h-16 mx-auto mb-4 bg-indigo-100 rounded-full flex items-center justify-center group-hover:bg-indigo-200 transition-colors">
                                <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                    </path>
                                </svg>
                            </div>
                            <p class="text-gray-600 font-medium">Drop front photo here</p>
                            <p class="text-gray-400 text-sm mt-1">or click to browse</p>
                            <p class="text-gray-400 text-xs mt-3">Stand facing the camera, full body visible</p>
                        </div>
                        <div id="front-upload-preview" class="hidden">
                            <img id="front-upload-img" class="max-h-64 mx-auto rounded-lg shadow-md" alt="Front view">
                            <p class="text-green-600 font-medium mt-3">‚úì Front image ready</p>
                            <button type="button" onclick="event.stopPropagation(); removeUpload('front')"
                                class="mt-2 text-sm text-red-500 hover:text-red-700 underline">Remove</button>
                        </div>
                    </div>
                </div>

                <!-- Side Image Upload -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        üìê Side View <span class="text-gray-400 font-normal">(optional)</span>
                    </label>
                    <div id="side-dropzone"
                        class="relative border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer transition-all duration-300 hover:border-purple-400 hover:bg-purple-50/50 group"
                        onclick="document.getElementById('side-file-input').click()"
                        ondragover="handleDragOver(event, 'side-dropzone')"
                        ondragleave="handleDragLeave(event, 'side-dropzone')" ondrop="handleDrop(event, 'side')">
                        <input type="file" id="side-file-input" accept="image/*" class="hidden"
                            onchange="handleFileSelect(event, 'side')">
                        <div id="side-upload-placeholder">
                            <div
                                class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-purple-100 transition-colors">
                                <svg class="w-8 h-8 text-gray-400 group-hover:text-purple-500 transition-colors"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                    </path>
                                </svg>
                            </div>
                            <p class="text-gray-600 font-medium">Drop side photo here</p>
                            <p class="text-gray-400 text-sm mt-1">or click to browse</p>
                            <p class="text-gray-400 text-xs mt-3">Stand sideways, full body visible</p>
                        </div>
                        <div id="side-upload-preview" class="hidden">
                            <img id="side-upload-img" class="max-h-64 mx-auto rounded-lg shadow-md" alt="Side view">
                            <p class="text-green-600 font-medium mt-3">‚úì Side image ready</p>
                            <button type="button" onclick="event.stopPropagation(); removeUpload('side')"
                                class="mt-2 text-sm text-red-500 hover:text-red-700 underline">Remove</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Tips -->
            <div class="bg-indigo-50 rounded-xl p-5 mb-6">
                <h3 class="font-bold text-indigo-900 mb-2">üìã Tips for best results:</h3>
                <ul class="space-y-1.5 text-sm text-indigo-800">
                    <li>‚úì Full body visible from head to toe</li>
                    <li>‚úì Good, even lighting</li>
                    <li>‚úì Stand straight with arms slightly away from body</li>
                    <li>‚úì Wear fitted clothing for more accurate measurements</li>
                </ul>
            </div>

            <!-- Upload Error -->
            <div id="upload-error" class="hidden bg-red-50 border-2 border-red-200 rounded-xl p-4 mb-6">
                <p class="text-red-800 font-medium"></p>
            </div>

            <!-- Upload Loading -->
            <div id="upload-loading" class="hidden bg-gray-900/80 rounded-xl p-8 mb-6">
                <div class="text-center">
                    <div
                        class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-400 mx-auto mb-4">
                    </div>
                    <p class="text-white text-lg font-medium">Analyzing your images with AI...</p>
                    <p class="text-gray-400 text-sm mt-2">This may take a few seconds</p>
                </div>
            </div>

            <!-- Upload Action Button -->
            <div class="flex justify-center">
                <button id="upload-process-btn" onclick="processUpload()" disabled
                    class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-10 py-4 rounded-xl font-bold text-lg shadow-lg transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed hover:shadow-xl hover:scale-105 disabled:hover:scale-100 disabled:hover:shadow-lg">
                    ‚ú® Process Scan
                </button>
            </div>
        </div>
    </div><!-- /upload-mode -->

</div>

<style>
    @keyframes flash {
        0% {
            opacity: 1;
        }

        100% {
            opacity: 0;
        }
    }

    .animate-flash {
        animation: flash 0.3s ease-out forwards;
    }

    @keyframes pulse-border {

        0%,
        100% {
            border-color: rgba(34, 197, 94, 0.8);
        }

        50% {
            border-color: rgba(34, 197, 94, 0.4);
        }
    }

    .pulse-border-green {
        animation: pulse-border 1s ease-in-out infinite;
    }
</style>

<script src="{% static 'js/camera.js' %}"></script>
{% endblock %}

{% block extra_js %}
<script>
    // Camera and scanning logic
    let video, canvas, context, overlayCanvas, overlayContext;
    let frontImageData = null;
    let sideImageData = null;
    let skinImageData = null;
    let currentStep = 1;
    let analysisInterval = null;
    let isAnalyzing = false;

    // Auto-capture variables
    let goodPoseStartTime = null;
    const AUTO_CAPTURE_DELAY = 2000; // 2 seconds of good pose before capture
    let countdownActive = false;
    let countdownValue = 3;

    document.addEventListener('DOMContentLoaded', function () {
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        context = canvas.getContext('2d');
        overlayCanvas = document.getElementById('overlay-canvas');
        overlayContext = overlayCanvas.getContext('2d');

        // Resize overlay canvas to match video
        window.addEventListener('resize', resizeOverlay);

        // Initialize camera
        initCamera();

        // Button event listeners
        document.getElementById('skip-side').addEventListener('click', skipSide);
        document.getElementById('process-scan').addEventListener('click', processScan);
        document.getElementById('retake').addEventListener('click', retake);
    });

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 960 },
                    facingMode: 'user'
                }
            });
            video.srcObject = stream;

            video.onloadedmetadata = () => {
                resizeOverlay();
                // Start real-time analysis
                startRealTimeAnalysis();
            };
        } catch (error) {
            showError('Camera access denied. Please allow camera access to use this feature.');
            console.error('Camera error:', error);
            updateStatus('error', 'Camera access denied');
        }
    }

    function resizeOverlay() {
        overlayCanvas.width = video.videoWidth || video.clientWidth;
        overlayCanvas.height = video.videoHeight || video.clientHeight;
    }

    function startRealTimeAnalysis() {
        if (isAnalyzing) return;
        isAnalyzing = true;
        goodPoseStartTime = null;

        updateStatus('warning', 'Align your body with the guide');
        document.getElementById('auto-capture-bar').classList.remove('hidden');

        // Analysis loop
        analysisInterval = setInterval(async () => {
            if (!isAnalyzing || video.paused || video.ended || countdownActive) return;

            // Capture low-res frame
            const analysisCanvas = document.createElement('canvas');
            analysisCanvas.width = 320;
            analysisCanvas.height = 240;
            const ctx = analysisCanvas.getContext('2d');

            ctx.drawImage(video, 0, 0, 320, 240);

            const imageData = analysisCanvas.toDataURL('image/jpeg', 0.6);

            try {
                // Send mode based on current step (face mode for skin tone step)
                const analysisMode = currentStep === 3 ? 'face' : 'body';

                const response = await fetch('{% url "fitting_system:analyze_frame" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData, mode: analysisMode })
                });

                const result = await response.json();
                handleAnalysisResult(result);

            } catch (error) {
                console.error("Analysis frame error:", error);
            }
        }, 200); // ~5 FPS for smoother feedback
    }

    function stopAnalysis() {
        isAnalyzing = false;
        goodPoseStartTime = null;
        if (analysisInterval) {
            clearInterval(analysisInterval);
            analysisInterval = null;
        }
        overlayContext.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        document.getElementById('auto-capture-bar').classList.add('hidden');
        document.getElementById('capture-progress').style.width = '0%';
    }

    function handleAnalysisResult(result) {
        if (!result.detected) {
            updateStatus('error', 'No person detected - step into frame');
            clearLandmarks();
            goodPoseStartTime = null;
            updateCaptureProgress(0);
            return;
        }

        updateStatus(result.status, result.message);

        // Draw landmarks if available
        if (result.landmarks && result.landmarks.length > 0) {
            drawLandmarks(result.landmarks, result.status);
        }

        // Handle auto-capture logic
        if (result.status === 'good') {
            if (!goodPoseStartTime) {
                goodPoseStartTime = Date.now();
            }

            const elapsed = Date.now() - goodPoseStartTime;
            const progress = Math.min(100, (elapsed / AUTO_CAPTURE_DELAY) * 100);
            updateCaptureProgress(progress);

            // Update guide color to green
            updateGuideColor('good');

            if (elapsed >= AUTO_CAPTURE_DELAY && !countdownActive) {
                // Start countdown
                startCountdown();
            }
        } else {
            // Reset if pose is not good
            goodPoseStartTime = null;
            updateCaptureProgress(0);
            updateGuideColor(result.status);
        }
    }

    function updateCaptureProgress(progress) {
        document.getElementById('capture-progress').style.width = progress + '%';
    }

    function updateGuideColor(status) {
        const headGuide = document.getElementById('head-guide');
        const bodyGuide = document.getElementById('body-guide');
        const faceGuide = document.getElementById('face-guide');

        // Reset classes
        [headGuide, bodyGuide, faceGuide].forEach(el => {
            if (el) {
                el.classList.remove('border-green-400', 'border-yellow-400', 'border-red-400', 'pulse-border-green', 'border-white/70', 'border-amber-400/80');
            }
        });

        if (status === 'good') {
            headGuide.classList.add('border-green-400', 'pulse-border-green');
            bodyGuide.classList.add('border-green-400', 'pulse-border-green');
            faceGuide.classList.add('border-green-400', 'pulse-border-green');
        } else if (status === 'warning') {
            headGuide.classList.add('border-yellow-400');
            bodyGuide.classList.add('border-yellow-400');
            faceGuide.classList.add('border-amber-400/80');
        } else {
            headGuide.classList.add('border-white/70');
            bodyGuide.classList.add('border-white/70');
            faceGuide.classList.add('border-amber-400/80');
        }
    }

    function startCountdown() {
        countdownActive = true;
        countdownValue = 3;

        const countdownOverlay = document.getElementById('countdown-overlay');
        const countdownNumber = document.getElementById('countdown-number');

        countdownOverlay.classList.remove('hidden');
        countdownNumber.textContent = countdownValue;

        const countdownInterval = setInterval(() => {
            countdownValue--;

            if (countdownValue > 0) {
                countdownNumber.textContent = countdownValue;
            } else {
                clearInterval(countdownInterval);
                countdownOverlay.classList.add('hidden');
                triggerAutoCapture();
            }
        }, 1000);
    }

    function triggerAutoCapture() {
        // Show flash effect
        const flash = document.getElementById('capture-flash');
        flash.classList.remove('hidden');
        setTimeout(() => flash.classList.add('hidden'), 300);

        // Capture based on current step
        if (currentStep === 1) {
            captureAutoFront();
        } else if (currentStep === 2) {
            captureAutoSide();
        } else if (currentStep === 3) {
            captureAutoSkin();
        }

        countdownActive = false;
    }

    function updateStatus(status, message) {
        const badge = document.getElementById('status-badge');
        const indicator = document.getElementById('status-indicator');
        const text = document.getElementById('status-text');

        text.textContent = message;

        // Reset classes
        indicator.className = 'w-3 h-3 rounded-full animate-pulse transition-colors duration-300';
        badge.className = 'backdrop-blur-md px-6 py-2 rounded-full flex items-center gap-2 transition-all duration-300 border-2';

        if (status === 'good') {
            indicator.classList.add('bg-green-400');
            badge.classList.add('bg-green-900/60', 'border-green-400');
        } else if (status === 'warning') {
            indicator.classList.add('bg-yellow-400');
            badge.classList.add('bg-yellow-900/60', 'border-yellow-400');
        } else {
            indicator.classList.add('bg-red-500');
            badge.classList.add('bg-red-900/60', 'border-red-500');
        }
    }

    const POSE_CONNECTIONS = [
        [11, 12], // Shoulders
        [11, 13], [13, 15], // Left arm
        [12, 14], [14, 16], // Right arm
        [11, 23], [12, 24], // Torso
        [23, 24], // Hips
        [23, 25], [25, 27], // Left leg
        [24, 26], [26, 28]  // Right leg
    ];

    function drawLandmarks(landmarks, status) {
        overlayContext.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

        let color = '#34d399'; // emerald-400
        if (status === 'warning') color = '#fbbf24'; // yellow-400
        if (status === 'error') color = '#ef4444'; // red-500

        overlayContext.strokeStyle = color;
        overlayContext.lineWidth = 4;
        overlayContext.lineCap = 'round';
        overlayContext.lineJoin = 'round';

        // Add glow effect
        overlayContext.shadowBlur = 15;
        overlayContext.shadowColor = color;

        // Draw Connections (Skeleton)
        POSE_CONNECTIONS.forEach(([i, j]) => {
            const lm1 = landmarks[i];
            const lm2 = landmarks[j];
            if (lm1 && lm2 && lm1.x !== undefined && lm2.x !== undefined) {
                const x1 = (1 - lm1.x) * overlayCanvas.width;
                const y1 = lm1.y * overlayCanvas.height;
                const x2 = (1 - lm2.x) * overlayCanvas.width;
                const y2 = lm2.y * overlayCanvas.height;

                overlayContext.beginPath();
                overlayContext.moveTo(x1, y1);
                overlayContext.lineTo(x2, y2);
                overlayContext.stroke();
            }
        });

        // Draw Joint Points
        landmarks.forEach((lm, index) => {
            // Focus on key joints for a cleaner look
            const keyJoints = [11, 12, 13, 14, 15, 16, 23, 24, 25, 26, 27, 28, 0];
            if (!keyJoints.includes(index)) return;

            const x = (1 - lm.x) * overlayCanvas.width;
            const y = lm.y * overlayCanvas.height;

            // Outer glow circle
            overlayContext.beginPath();
            overlayContext.fillStyle = color;
            overlayContext.arc(x, y, 6, 0, 2 * Math.PI);
            overlayContext.fill();

            // Inner white dot for "premium" look
            overlayContext.beginPath();
            overlayContext.fillStyle = '#FFFFFF';
            overlayContext.arc(x, y, 3, 0, 2 * Math.PI);
            overlayContext.fill();
        });

        overlayContext.shadowBlur = 0; // Reset shadow for other drawing operations
    }

    function clearLandmarks() {
        overlayContext.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
    }

    function captureImage() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        context.save();
        context.scale(-1, 1);
        context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
        context.restore();

        return canvas.toDataURL('image/jpeg', 0.9);
    }

    function captureAutoFront() {
        stopAnalysis();

        frontImageData = captureImage();

        // Show preview
        document.getElementById('front-preview').src = frontImageData;
        document.getElementById('preview-container').classList.remove('hidden');
        document.getElementById('front-preview-container').classList.remove('hidden');

        // Show skip side button
        document.getElementById('skip-side').classList.remove('hidden');

        // Update step
        updateStep(2);

        // Update instructions
        document.getElementById('instructions').innerHTML = `
            <h3 class="font-bold text-lg text-indigo-900 mb-3">üì∏ Step 2: Side View (Auto-Capture)</h3>
            <ul class="space-y-2 text-indigo-800">
                <li>‚úì Turn 90 degrees to your right</li>
                <li>‚úì Stand in the same position</li>
                <li>‚úì Keep your arms at your sides</li>
                <li>‚ö° <strong>Image will capture automatically!</strong></li>
                <li>Or click "Skip Side View" to continue</li>
            </ul>
        `;

        // Restart analysis for side view
        setTimeout(() => startRealTimeAnalysis(), 500);
    }

    function captureAutoSide() {
        stopAnalysis();

        sideImageData = captureImage();

        // Show preview
        document.getElementById('side-preview').src = sideImageData;
        document.getElementById('side-preview-container').classList.remove('hidden');

        // Move to Skin Tone step
        moveToSkinToneStep();
    }

    function skipSide() {
        stopAnalysis();
        document.getElementById('skip-side').classList.add('hidden');
        moveToSkinToneStep();
    }

    function moveToSkinToneStep() {
        // Hide skip button
        document.getElementById('skip-side').classList.add('hidden');

        // Switch visual guides
        document.getElementById('visual-guide-body').classList.add('hidden');
        document.getElementById('visual-guide-face').classList.remove('hidden');

        // Update step
        updateStep(3);

        // Update instructions
        document.getElementById('instructions').innerHTML = `
            <h3 class="font-bold text-lg text-amber-700 mb-3">üé® Step 3: Skin Tone Analysis (Selfie Mode)</h3>
            <ul class="space-y-2 text-amber-800">
                <li>üì± <strong>Come close to the camera like a selfie!</strong></li>
                <li>‚úì Your face should fill most of the circle</li>
                <li>‚úì Position your face in the center of the guide</li>
                <li>‚úì Ensure good, natural lighting on your face</li>
                <li>‚ö° <strong>Image will capture automatically when you're close enough!</strong></li>
            </ul>
        `;

        // Restart analysis for skin tone
        setTimeout(() => startRealTimeAnalysis(), 500);
    }

    function captureAutoSkin() {
        stopAnalysis();

        skinImageData = captureImage();

        // Show preview
        document.getElementById('skin-preview').src = skinImageData;
        document.getElementById('skin-preview-container').classList.remove('hidden');

        // Hide face guide
        document.getElementById('visual-guide-face').classList.add('hidden');

        // Show process button
        document.getElementById('process-scan').classList.remove('hidden');
        document.getElementById('retake').classList.remove('hidden');

        // Update step
        updateStep(4);

        // Update instructions
        document.getElementById('instructions').innerHTML = `
            <h3 class="font-bold text-lg text-emerald-700 mb-3">‚ú® Step 4: Ready to Process</h3>
            <ul class="space-y-2 text-emerald-800">
                <li>‚úì All images captured successfully!</li>
                <li>‚úì Click "Process Scan" to analyze your measurements</li>
                <li>‚úì You can also start over if needed</li>
            </ul>
        `;

        updateStatus('good', 'Ready to process your scan!');
    }

    async function processScan() {
        if (!frontImageData) {
            showError('Please capture at least a front view image.');
            return;
        }

        if (!skinImageData) {
            showError('Please capture a skin tone image.');
            return;
        }

        // Show loading
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('process-scan').disabled = true;

        try {
            const response = await fetch('{% url "fitting_system:process_scan" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    front_image: frontImageData,
                    side_image: sideImageData,
                    skin_image: skinImageData
                })
            });

            const data = await response.json();

            if (data.success) {
                window.location.href = `/recommendations/${data.session_id}/`;
            } else {
                showError(data.error || 'Processing failed. Please try again.');
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('process-scan').disabled = false;
            }
        } catch (error) {
            showError('Network error. Please check your connection and try again.');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('process-scan').disabled = false;
            console.error('Processing error:', error);
        }
    }

    function retake() {
        // Reset everything
        frontImageData = null;
        sideImageData = null;
        skinImageData = null;
        currentStep = 1;
        goodPoseStartTime = null;
        countdownActive = false;

        // Reset UI
        document.getElementById('preview-container').classList.add('hidden');
        document.getElementById('front-preview-container').classList.add('hidden');
        document.getElementById('side-preview-container').classList.add('hidden');
        document.getElementById('skin-preview-container').classList.add('hidden');
        document.getElementById('skip-side').classList.add('hidden');
        document.getElementById('process-scan').classList.add('hidden');
        document.getElementById('retake').classList.add('hidden');
        document.getElementById('error-message').classList.add('hidden');

        // Reset visual guides
        document.getElementById('visual-guide-body').classList.remove('hidden');
        document.getElementById('visual-guide-face').classList.add('hidden');

        // Reset instructions
        document.getElementById('instructions').innerHTML = `
            <h3 class="font-bold text-lg text-indigo-900 mb-3">üì∏ Step 1: Front View (Auto-Capture)</h3>
            <ul class="space-y-2 text-indigo-800">
                <li>‚úì Stand 2-3 meters away from the camera</li>
                <li>‚úì Align your body with the guide outline</li>
                <li>‚úì Stand straight with arms slightly away from your body</li>
                <li>‚ö° <strong>Image will capture automatically when you're positioned correctly!</strong></li>
            </ul>
        `;

        updateStep(1);
        startRealTimeAnalysis();
    }

    function updateStep(step) {
        currentStep = step;
        const totalSteps = 4;

        for (let i = 1; i <= totalSteps; i++) {
            const stepEl = document.getElementById(`step${i}`);
            if (i < step) {
                stepEl.classList.remove('opacity-50');
                stepEl.querySelector('div').classList.remove('bg-gray-300', 'text-gray-600', 'bg-indigo-600');
                stepEl.querySelector('div').classList.add('bg-green-500', 'text-white');
                stepEl.querySelector('span').classList.remove('text-gray-600');
                stepEl.querySelector('span').classList.add('text-gray-900');
            } else if (i === step) {
                stepEl.classList.remove('opacity-50');
                stepEl.querySelector('div').classList.remove('bg-gray-300', 'text-gray-600', 'bg-green-500');
                stepEl.querySelector('div').classList.add('bg-indigo-600', 'text-white');
                stepEl.querySelector('span').classList.remove('text-gray-600');
                stepEl.querySelector('span').classList.add('text-gray-900');
            } else {
                stepEl.classList.add('opacity-50');
                stepEl.querySelector('div').classList.remove('bg-indigo-600', 'bg-green-500', 'text-white');
                stepEl.querySelector('div').classList.add('bg-gray-300', 'text-gray-600');
                stepEl.querySelector('span').classList.remove('text-gray-900');
                stepEl.querySelector('span').classList.add('text-gray-600');
            }
        }
    }

    function showError(message) {
        const errorEl = document.getElementById('error-message');
        errorEl.querySelector('p').textContent = message;
        errorEl.classList.remove('hidden');
    }

    // ===== UPLOAD MODE FUNCTIONS =====
    let uploadFrontData = null;
    let uploadSideData = null;
    let currentMode = 'camera'; // 'camera' or 'upload'

    function switchMode(mode) {
        currentMode = mode;
        const cameraMode = document.getElementById('camera-mode');
        const uploadMode = document.getElementById('upload-mode');
        const tabCamera = document.getElementById('tab-camera');
        const tabUpload = document.getElementById('tab-upload');

        if (mode === 'camera') {
            cameraMode.classList.remove('hidden');
            uploadMode.classList.add('hidden');
            tabCamera.className = 'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-300 bg-white text-indigo-700 shadow-md';
            tabUpload.className = 'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-300 text-gray-500 hover:text-gray-700';
            // Resume camera if it was running
            if (video && video.srcObject) {
                video.play();
            }
        } else {
            cameraMode.classList.add('hidden');
            uploadMode.classList.remove('hidden');
            tabCamera.className = 'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-300 text-gray-500 hover:text-gray-700';
            tabUpload.className = 'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-300 bg-white text-indigo-700 shadow-md';
            // Pause camera to save resources
            if (video && video.srcObject) {
                video.pause();
            }
            stopAnalysis();
        }
    }

    function handleDragOver(e, dropzoneId) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById(dropzoneId).classList.add('border-indigo-500', 'bg-indigo-50');
    }

    function handleDragLeave(e, dropzoneId) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById(dropzoneId).classList.remove('border-indigo-500', 'bg-indigo-50');
    }

    function handleDrop(e, type) {
        e.preventDefault();
        e.stopPropagation();
        const dropzoneId = type + '-dropzone';
        document.getElementById(dropzoneId).classList.remove('border-indigo-500', 'bg-indigo-50');

        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
            readFileAsBase64(files[0], type);
        }
    }

    function handleFileSelect(e, type) {
        const files = e.target.files;
        if (files.length > 0) {
            readFileAsBase64(files[0], type);
        }
    }

    function readFileAsBase64(file, type) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const base64Data = e.target.result; // data:image/...;base64,...

            if (type === 'front') {
                uploadFrontData = base64Data;
                document.getElementById('front-upload-img').src = base64Data;
                document.getElementById('front-upload-placeholder').classList.add('hidden');
                document.getElementById('front-upload-preview').classList.remove('hidden');
            } else {
                uploadSideData = base64Data;
                document.getElementById('side-upload-img').src = base64Data;
                document.getElementById('side-upload-placeholder').classList.add('hidden');
                document.getElementById('side-upload-preview').classList.remove('hidden');
            }

            updateUploadButton();
        };
        reader.readAsDataURL(file);
    }

    function removeUpload(type) {
        if (type === 'front') {
            uploadFrontData = null;
            document.getElementById('front-upload-placeholder').classList.remove('hidden');
            document.getElementById('front-upload-preview').classList.add('hidden');
            document.getElementById('front-file-input').value = '';
        } else {
            uploadSideData = null;
            document.getElementById('side-upload-placeholder').classList.remove('hidden');
            document.getElementById('side-upload-preview').classList.add('hidden');
            document.getElementById('side-file-input').value = '';
        }
        updateUploadButton();
    }

    function updateUploadButton() {
        const btn = document.getElementById('upload-process-btn');
        btn.disabled = !uploadFrontData;
    }

    async function processUpload() {
        if (!uploadFrontData) {
            showUploadError('Please upload a front view image.');
            return;
        }

        // Show loading
        document.getElementById('upload-loading').classList.remove('hidden');
        document.getElementById('upload-process-btn').disabled = true;
        document.getElementById('upload-error').classList.add('hidden');

        try {
            const response = await fetch('{% url "fitting_system:process_scan" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    front_image: uploadFrontData,
                    side_image: uploadSideData
                })
            });

            const data = await response.json();

            if (data.success) {
                window.location.href = `/recommendations/${data.session_id}/`;
            } else {
                showUploadError(data.error || 'Processing failed. Please try again.');
                document.getElementById('upload-loading').classList.add('hidden');
                document.getElementById('upload-process-btn').disabled = false;
            }
        } catch (error) {
            showUploadError('Network error. Please check your connection and try again.');
            document.getElementById('upload-loading').classList.add('hidden');
            document.getElementById('upload-process-btn').disabled = false;
            console.error('Upload processing error:', error);
        }
    }

    function showUploadError(message) {
        const errorEl = document.getElementById('upload-error');
        errorEl.querySelector('p').textContent = message;
        errorEl.classList.remove('hidden');
    }
</script>
{% endblock %}